#!/bin/bash

./register_joint_states.sh &

REGISTER_PID=$!
echo "Started register_joint_states.sh with PID ${REGISTER_PID}"

sleep 1


read -r -d '' WAYPOINTS << 'EOF'
  Step 1: [3.92701957 0.91591986 2.2        1.        ]
  Step 2: [3.99216136 1.19699727 2.2        1.        ]
  Step 3: [3.8367569  1.37676881 2.12477126 1.10397032]
  Step 4: [3.65118338 1.54268248 2.0392518  1.22216298]
  Step 5: [3.64289692 1.79075337 1.95291129 1.33504266]
  Step 6: [3.52922173 1.91929021 1.88453666 1.48008751]
  Step 7: [3.33213339 1.93265804 1.74769795 1.57180879]
  Step 8: [3.16342297 1.95021467 1.5143215  1.5683518 ]
  Step 9: [3.02100556 1.92496609 1.51895287 1.47023242]
  Step 10: [2.89891753 1.86662118 1.7076084  1.29892148]
  Step 11: [2.73806749 1.76950001 1.87472139 1.22942898]
  Step 12: [2.62119454 1.57032886 1.91860693 1.16067252]
  Step 13: [2.57717896 1.32868837 1.93097213 1.05046585]
  Step 14: [2.57812041 1.08391359 2.08218767 1.07205858]
  Step 15: [2.5        0.92372815 2.2        1.        ]
  Step 1: [2.5        0.92372815 2.2        1.        ]
  Step 2: [2.57811826 1.08447212 2.08184262 1.07200931]
  Step 3: [2.57717466 1.32980544 1.93028204 1.05036731]
  Step 4: [2.62158036 1.57197712 1.91878329 1.16167469]
  Step 5: [2.73992392 1.77077491 1.8734119  1.22904329]
  Step 6: [2.90031045 1.86728684 1.705456   1.30087599]
  Step 7: [3.02267706 1.92576489 1.51637    1.47257784]
  Step 8: [3.16611775 1.94993424 1.51804917 1.56840702]
  Step 9: [3.33521314 1.93233755 1.75195815 1.5718719 ]
  Step 10: [3.53378786 1.91909224 1.88558251 1.4764644 ]
  Step 11: [3.64293316 1.78502199 1.95488214 1.33247152]
  Step 12: [3.65584129 1.53851803 2.04139834 1.21919634]
  Step 13: [3.84183826 1.37222578 2.12711295 1.10073397]
  Step 14: [3.98317902 1.19094472 2.2        1.        ]
  Step 15: [3.87078006 0.92449625 2.2        1.        ]
  Step 1: [3.87078006 0.92449625 2.2        1.        ]
  Step 2: [3.97504533 1.17166331 2.2        1.        ]
  Step 3: [3.86875741 1.34815847 2.13951833 1.08358903]
  Step 4: [3.69622002 1.50241707 2.06000642 1.19347893]
  Step 5: [3.64339393 1.7121515  1.97994011 1.29978128]
  Step 6: [3.61442003 1.91559628 1.90405101 1.4124848 ]
  Step 7: [3.40863215 1.9246973  1.85351838 1.57337631]
  Step 8: [3.25177326 1.94102061 1.6365361  1.57016216]
  Step 9: [3.09491437 1.95734392 1.41955383 1.56694802]
  Step 10: [2.98000543 1.90537245 1.58230798 1.41270204]
  Step 11: [2.86649381 1.85112613 1.75771087 1.25342532]
  Step 12: [2.69833907 1.74221662 1.90274507 1.23768291]
  Step 13: [2.61414486 1.5402119  1.9153844  1.14236077]
  Step 14: [2.55963924 1.34886903 1.96632294 1.03549547]
  Step 15: [2.5        1.23688213 2.2        1.        ]
  Step 1: [2.5        1.23688213 2.2        1.        ]
  Step 2: [2.55435972 1.33895548 1.987009   1.03235326]
  Step 3: [2.60486723 1.50057687 1.91114343 1.11826183]
  Step 4: [2.65263012 1.70462492 1.93297667 1.24232737]
  Step 5: [2.82048246 1.82609829 1.81658742 1.21230653]
  Step 6: [2.92976282 1.8813619  1.65994495 1.34220285]
  Step 7: [3.03322592 1.93080611 1.50006946 1.48737974]
  Step 8: [3.15457265 1.95113566 1.50207888 1.56817045]
  Step 9: [3.29754574 1.93625736 1.69985298 1.57110007]
  Step 10: [3.44971969 1.92273718 1.86632701 1.54317039]
  Step 11: [3.63814329 1.91456771 1.90948474 1.39366099]
  Step 12: [3.64343266 1.70602501 1.98204683 1.29703289]
  Step 13: [3.68547267 1.51202583 2.05505363 1.20032397]
  Step 14: [3.84273634 1.37142284 2.12752682 1.10016198]
  Step 15: [4.         1.23081985 2.2        1.        ]
  Step 1: [4.         1.23081985 2.2        1.        ]
  Step 2: [3.91041411 1.36873727 2.09265734 1.25431594]
  Step 3: [3.82502309 1.51350988 1.84612045 1.31515373]
  Step 4: [3.75233335 1.74881141 1.89385385 1.32962608]
  Step 5: [3.47368622 1.87293655 1.81421149 1.37763218]
  Step 6: [3.23571504 1.96349887 1.69078782 1.43648938]
  Step 7: [3.16697781 1.91083059 1.41111267 1.55078789]
  Step 8: [2.99885777 1.80330415 1.27315831 1.72928088]
  Step 9: [2.76737049 1.71317725 1.46764671 1.79019834]
  Step 10: [2.64983138 1.47987782 1.60854553 1.70762818]
  Step 11: [2.63716505 1.22723817 1.71643444 1.56331046]
  Step 12: [2.61212388 0.96151042 1.84750725 1.44909008]
  Step 13: [2.58976798 0.72926355 1.96678509 1.28715191]
  Step 14: [2.56170881 0.50992647 2.07352756 1.10367392]
  Step 15: [2.5        0.24030756 2.2        1.        ]
  Step 1: [2.5        0.24030756 2.2        1.        ]
  Step 2: [2.55788894 0.49323663 2.08135641 1.09725634]
  Step 3: [2.59000953 0.7076607  1.9778217  1.25562533]
  Step 4: [2.60516362 0.91170769 1.87313939 1.42973029]
  Step 5: [2.64032377 1.16328907 1.74365717 1.52752737]
  Step 6: [2.61861223 1.40118621 1.64972803 1.67557421]
  Step 7: [2.71323542 1.63969533 1.52490657 1.77272769]
  Step 8: [2.89855175 1.76425116 1.3574323  1.75567709]
  Step 9: [3.08677831 1.85674309 1.32676487 1.64484961]
  Step 10: [3.2052626  1.93891444 1.52577715 1.49380274]
  Step 11: [3.29959402 1.94867629 1.76305365 1.40763403]
  Step 12: [3.56342505 1.83389519 1.84058168 1.3621672 ]
  Step 13: [3.72609215 1.74134997 1.97729943 1.31994091]
  Step 14: [3.78886052 1.69640614 2.14535291 1.20136344]
  Step 15: [4.         1.64400457 2.2        1.        ]
  Step 1: [4.         1.64400457 2.2        1.        ]
  Step 2: [3.78886052 1.69640614 2.14535291 1.20136344]
  Step 3: [3.72609215 1.74134997 1.97729943 1.31994091]
  Step 4: [3.56342505 1.83389519 1.84058168 1.3621672 ]
  Step 5: [3.29959402 1.94867629 1.76305365 1.40763403]
  Step 6: [3.2052626  1.93891444 1.52577715 1.49380274]
  Step 7: [3.08677831 1.85674309 1.32676487 1.64484961]
  Step 8: [2.89855175 1.76425116 1.3574323  1.75567709]
  Step 9: [2.71323542 1.63969533 1.52490657 1.77272769]
  Step 10: [2.61861223 1.40118621 1.64972803 1.67557421]
  Step 11: [2.64032377 1.16328907 1.74365717 1.52752737]
  Step 12: [2.60516362 0.91170769 1.87313939 1.42973029]
  Step 13: [2.59000953 0.7076607  1.9778217  1.25562533]
  Step 14: [2.55788894 0.49323663 2.08135641 1.09725634]
  Step 15: [2.5        0.24030756 2.2        1.        ]
  Step 1: [2.5        0.24030756 2.2        1.        ]
  Step 2: [2.5        0.59547981 2.2        1.        ]
  Step 3: [2.50524975 0.94652751 2.18978241 0.99144856]
  Step 4: [2.57450297 1.2472899  2.05499504 0.87864047]
  Step 5: [2.60534603 1.53637467 1.88920473 0.81380539]
  Step 6: [2.81134872 1.78064452 1.73994492 0.82950905]
  Step 7: [3.00432979 1.95382944 1.50135907 0.78490627]
  Step 8: [3.23663369 1.84886383 1.30323542 0.82006306]
  Step 9: [3.45311399 1.7003052  1.3049457  0.79260714]
  Step 10: [3.63727265 1.58072734 1.55083126 0.6604166 ]
  Step 11: [3.80343208 1.39621292 1.80233957 0.64158316]
  Step 12: [3.94940853 1.21842633 2.04527256 0.7462329 ]
  Step 13: [3.93261251 0.96886976 2.17455358 0.95540866]
  Step 14: [3.95926858 0.63656831 2.2        1.        ]
  Step 15: [4.         0.28373934 2.2        1.        ]
  Step 1: [4.         0.28373934 2.2        1.        ]
  Step 2: [3.95926858 0.63656831 2.2        1.        ]
  Step 3: [3.93261251 0.96886976 2.17455358 0.95540866]
  Step 4: [3.94940853 1.21842633 2.04527256 0.7462329 ]
  Step 5: [3.80343208 1.39621292 1.80233957 0.64158316]
  Step 6: [3.63727265 1.58072734 1.55083126 0.6604166 ]
  Step 7: [3.45311399 1.7003052  1.3049457  0.79260714]
  Step 8: [3.23663369 1.84886383 1.30323542 0.82006306]
  Step 9: [3.00432979 1.95382944 1.50135907 0.78490627]
  Step 10: [2.81134872 1.78064452 1.73994492 0.82950905]
  Step 11: [2.60534603 1.53637467 1.88920473 0.81380539]
  Step 12: [2.57450297 1.2472899  2.05499504 0.87864047]
  Step 13: [2.50524975 0.94652751 2.18978241 0.99144856]
  Step 14: [2.5        0.59547981 2.2        1.        ]
  Step 15: [2.5        0.24030756 2.2        1.        ]
  Step 1: [2.5        0.24030756 2.2        1.        ]
  Step 2: [2.5        0.59547981 2.2        1.        ]
  Step 3: [2.50524975 0.94652751 2.18978241 0.99144856]
  Step 4: [2.57450297 1.2472899  2.05499504 0.87864047]
  Step 5: [2.60534603 1.53637467 1.88920473 0.81380539]
  Step 6: [2.81134872 1.78064452 1.73994492 0.82950905]
  Step 7: [3.00432979 1.95382944 1.50135907 0.78490627]
  Step 8: [3.23663369 1.84886383 1.30323542 0.82006306]
  Step 9: [3.45311399 1.7003052  1.3049457  0.79260714]
  Step 10: [3.63727265 1.58072734 1.55083126 0.6604166 ]
  Step 11: [3.80343208 1.39621292 1.80233957 0.64158316]
  Step 12: [3.94940853 1.21842633 2.04527256 0.7462329 ]
  Step 13: [3.93261251 0.96886976 2.17455358 0.95540866]
  Step 14: [3.95926858 0.63656831 2.2        1.        ]
  Step 15: [4.         0.28373934 2.2        1.        ]
EOF

while IFS= read -r line; do
  [[ -z "$line" ]] && continue

  echo "Processing: $line"

  numbers=$(echo "$line" | sed -n 's/.*\[\(.*\)\].*/\1/p')

  read -ra vals <<< "$numbers"
  if [[ ${#vals[@]} -ne 4 ]]; then
    echo "Warning: Expected 4 numbers but got ${#vals[@]} in line: $line"
    continue
  fi

  reversed=()
  for (( i=${#vals[@]}-1; i>=0; i-- )); do
    reversed+=( "${vals[i]}" )
  done

  positions="0.0"
  for num in "${reversed[@]}"; do
    positions+=", ${num}"
  done

  echo "Publishing waypoint with positions: [${positions}]"

  message="joint_names:
- 'axis_a'
- 'axis_b'
- 'axis_c'
- 'axis_d'
- 'axis_e'
points:
- positions: [${positions}]
  time_from_start:
    sec: 2
    nanosec: 0"

  ros2 topic pub /xsubsea/joint_trajectory trajectory_msgs/msg/JointTrajectory "$message" -1

  sleep 1

done <<< "$WAYPOINTS"

echo "Terminating register_joint_states.sh (PID ${REGISTER_PID})"
kill ${REGISTER_PID}
